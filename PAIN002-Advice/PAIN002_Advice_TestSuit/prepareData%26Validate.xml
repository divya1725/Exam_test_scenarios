<?xml version="1.0" encoding="UTF-8"?>
<con:testCase id="1a4c9de5-44a6-4b26-924f-1fd34ddbd9aa" discardOkResults="false" failOnError="true" failTestCaseOnErrors="true" keepSession="false" name="prepareData&amp;Validate" searchProperties="true" timeout="0" xmlns:con="http://eviware.com/soapui/config">
  <con:settings>
    <con:setting id="1a4c9de5-44a6-4b26-924f-1fd34ddbd9aafileName">prepareData%26Validate</con:setting>
  </con:settings>
  <con:savedRecentRuns>1</con:savedRecentRuns>
  <con:testStep type="manualTestStep" name="ReadMe" id="745dbe41-23a0-4ccb-99ed-09bad7fb5911" disabled="true">
    <con:description>Perform below preconditon actions before executing this TC.
    - Make sure the transactionID and other payment details are entered in preconditon step
    - Pass the PAIN002 xml file in the preconditon.XMLFile property and make sure the xml file has only one transaction record</con:description>
    <con:settings/>
    <con:config xsi:type="con:ManualTestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"/>
  </con:testStep>
  <con:testStep type="properties" name="PreCondition" id="0c838e20-a58c-486e-bcda-f808fec33cb8">
    <con:settings/>
    <con:config xsi:type="con:PropertiesStep" saveFirst="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:properties>
        <con:property>
          <con:name>userID</con:name>
          <con:value>TESTUSERPI28</con:value>
        </con:property>
        <con:property>
          <con:name>credentials</con:name>
          <con:value>03111012010400425kglPboRi3h16OVtVL1neI9CfuAtjCBO603eS0IgWm1WWIO7EfpSL4DE%2FlDFi69n1sSaabKNt2t%2BxJppso23a37Emmmyjbdrflpq4f56YEcTwqPbJGRxTVbEmmmyjbdrfsSaabKNt2t%2FXzlyjxYnxhcG46wcbIKp%2FsSaabKNt2t9wBUG0SyIoqFfig80Gq4uXVBtimDzTiu3EfQIWD5xMfpd8V90wfJqE%2FrpIdBWOZCg%3DWlPV5eZ4diuCWN8n8MioYhhi5y3ry7ocUG557FkHElWUtZW5y2o9bV4kNOBI2eIvhnMNNl4KZzZiP60aZOtzU6qC7h54%2FjtOS9LP2XwPBSwC3jUA00HIe25%2FFBsLnNciYlYLbkWKiTZCji3sjsSuUS8K0sIEsS3qoAJRWadlGrE%3D</con:value>
        </con:property>
        <con:property>
          <con:name>orgid</con:name>
          <con:value>4201</con:value>
        </con:property>
        <con:property>
          <con:name>channel</con:name>
          <con:value>NBA</con:value>
        </con:property>
        <con:property>
          <con:name>customerID</con:name>
          <con:value>08039417384</con:value>
        </con:property>
        <con:property>
          <con:name>agreementID</con:name>
          <con:value>08039417384</con:value>
        </con:property>
        <con:property>
          <con:name>TransactionID</con:name>
          <con:value>260270577</con:value>
        </con:property>
        <con:property>
          <con:name>SourcePath</con:name>
          <con:value>${#Project#sourcePath}</con:value>
        </con:property>
        <con:property>
          <con:name>Pain002SchemaPath</con:name>
          <con:value>C:\Ullasa\Projects\Pain002AdviceJob\V3\PAIN002-Advice-readyapi-project\PAIN002-Advice-readyapi-project\data\pain.002.001.04.xsd</con:value>
        </con:property>
        <con:property>
          <con:name>Pain002_File</con:name>
          <con:value><![CDATA[<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Document xmlns="urn:iso:std:iso:20022:tech:xsd:pain.002.001.04">
    <CstmrPmtStsRpt>
        <GrpHdr>
            <MsgId>01010077571.39361.479271</MsgId>
            <CreDtTm>2020-09-25T15:30:38.643+02:00</CreDtTm>
            <InitgPty>
                <Nm>SpareBank 1 SMN</Nm>
                <Id>
                    <OrgId>
                        <AnyBIC>SPTRNO22XXX</AnyBIC>
                        <Othr>
                            <Id>01010077571</Id>
                            <SchmeNm>
                                <Cd>BANK</Cd>
                            </SchmeNm>
                        </Othr>
                    </OrgId>
                </Id>
            </InitgPty>
            <DbtrAgt>
                <FinInstnId>
                    <ClrSysMmbId>
                        <ClrSysId>
                            <Prtry>NOBSK</Prtry>
                        </ClrSysId>
                        <MmbId>4201</MmbId>
                    </ClrSysMmbId>
                </FinInstnId>
            </DbtrAgt>
        </GrpHdr>
        <OrgnlGrpInfAndSts>
            <OrgnlMsgId>MSG_25920063202</OrgnlMsgId>
            <OrgnlMsgNmId>pain.001.001.04</OrgnlMsgNmId>
        </OrgnlGrpInfAndSts>
        <OrgnlPmtInfAndSts>
            <OrgnlPmtInfId>1502</OrgnlPmtInfId>
            <TxInfAndSts>
                <OrgnlInstrId>filepay01</OrgnlInstrId>
                <OrgnlEndToEndId>25920063202</OrgnlEndToEndId>
                <TxSts>RJCT</TxSts>
                <StsRsnInf>
                    <Rsn>
                        <Cd>DS02</Cd>
                    </Rsn>
                    <AddtlInf>260270574</AddtlInf>
                    <AddtlInf>01010077571</AddtlInf>
                </StsRsnInf>
            </TxInfAndSts>
            <TxInfAndSts>
                <OrgnlInstrId>filepay02</OrgnlInstrId>
                <OrgnlEndToEndId>25920063202</OrgnlEndToEndId>
                <TxSts>RJCT</TxSts>
                <StsRsnInf>
                    <Rsn>
                        <Cd>DS02</Cd>
                    </Rsn>
                    <AddtlInf>260270575</AddtlInf>
                    <AddtlInf>01010077571</AddtlInf>
                </StsRsnInf>
            </TxInfAndSts>
            <TxInfAndSts>
                <OrgnlInstrId>filepay03</OrgnlInstrId>
                <OrgnlEndToEndId>25920063202</OrgnlEndToEndId>
                <TxSts>RJCT</TxSts>
                <StsRsnInf>
                    <Rsn>
                        <Cd>DS02</Cd>
                    </Rsn>
                    <AddtlInf>260270576</AddtlInf>
                    <AddtlInf>01010077571</AddtlInf>
                </StsRsnInf>
            </TxInfAndSts>
            <TxInfAndSts>
                <OrgnlInstrId>filepay04</OrgnlInstrId>
                <OrgnlEndToEndId>25920063202</OrgnlEndToEndId>
                <TxSts>RJCT</TxSts>
                <StsRsnInf>
                    <Rsn>
                        <Cd>DS02</Cd>
                    </Rsn>
                    <AddtlInf>260270577</AddtlInf>
                    <AddtlInf>01010077571</AddtlInf>
                </StsRsnInf>
            </TxInfAndSts>
        </OrgnlPmtInfAndSts>
    </CstmrPmtStsRpt>
</Document>]]></con:value>
        </con:property>
      </con:properties>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="fetchPain002Schema" id="854c2d27-58e2-4824-9cf5-16bb46f23b02">
    <con:settings/>
    <con:config>
      <script>//In case of camt54 xsd Filename is changed, property  camt54SchemaPath must be changed accordingly
def Pain002SchemaPath =testRunner.testCase.testSuite.getProject().getPath()   + File.separator +  "data" + File.separator + "pain.002.001.04.xsd"
log.info Pain002SchemaPath

Pain002SchemaPath = Pain002SchemaPath.replace("//","/")
testRunner.testCase.getTestStepByName("PreCondition").setPropertyValue("Pain002SchemaPath", Pain002SchemaPath)</script>
    </con:config>
  </con:testStep>
  <con:testStep type="jdbc" name="fetchTransactionID" id="44fcbede-ad8b-4bd0-bc14-99c9643e4a1e">
    <con:settings>
      <con:setting id="prettyPrintResponse">true</con:setting>
    </con:settings>
    <con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:dbConnectionName>PENDATA</con:dbConnectionName>
      <con:driver>oracle.jdbc.driver.OracleDriver</con:driver>
      <con:connectionString>jdbc:oracle:thin:pwhdata/pwh@(DESCRIPTION=(ADDRESS_LIST=(LOAD_BALANCE=ON)(FAILOVER=ON)(ADDRESS=(PROTOCOL=TCP)(HOST=dlt-exa853-scan.unix.cosng.net)(PORT=1530)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=pwh_g_d4)))</con:connectionString>
      <con:password/>
      <con:connectionProperties/>
      <con:query>SELECT MAX(FK_TRANSACTIONSID) 
FROM ADVICETRANSACTION ATR, TRANSACTIONS TR ,PAYMENTINFO PIN 
WHERE ATR.FK_TRANSACTIONSID=TR.TRANSACTIONSID 
AND TR.FK_PAYMENTINFOID=PIN.PAYMENTINFOID 
AND PIN.INITIATORBANKID IN ('4201') 
AND ATR.FK_JOBID IN (SELECT JOBID 
				 FROM ADVICEJOB 
				 WHERE ADVICETYPE='PAIN' 
				 AND MARKETTYPE IS NOT NULL)</con:query>
      <con:assertion type="MessageContentAssertion" id="06bf82c4-3ddf-4332-ad3d-c70cd701b152" name="Message Content Assertion">
        <con:configuration xsi:type="con:MessageContentAssertion">
          <con:elements>
            <con:xpath>//Results[1]/ResultSet[1]/@fetchSize</con:xpath>
            <con:element>@fetchSize</con:element>
            <con:type/>
            <con:operator>=</con:operator>
            <con:enabled>true</con:enabled>
            <con:expectedValue>10</con:expectedValue>
            <con:hasValue>false</con:hasValue>
            <con:numberType>false</con:numberType>
          </con:elements>
          <con:elements>
            <con:xpath>//Results[1]/ResultSet[1]/Row[1]/@rowNumber</con:xpath>
            <con:element>@rowNumber</con:element>
            <con:type/>
            <con:operator>=</con:operator>
            <con:enabled>true</con:enabled>
            <con:expectedValue>1</con:expectedValue>
            <con:hasValue>false</con:hasValue>
            <con:numberType>false</con:numberType>
          </con:elements>
          <con:elements>
            <con:xpath>//Results[1]/ResultSet[1]/Row[1]/MAXFK_TRANSACTIONSID[1]</con:xpath>
            <con:element>MAXFK_TRANSACTIONSID</con:element>
            <con:type xsi:nil="true"/>
            <con:operator>exists</con:operator>
            <con:enabled>true</con:enabled>
            <con:expectedValue>156309</con:expectedValue>
            <con:hasValue>false</con:hasValue>
            <con:numberType>false</con:numberType>
          </con:elements>
          <con:originalMessage><![CDATA[<Results>
   <ResultSet fetchSize="10">
      <Row rowNumber="1">
         <MAXFK_TRANSACTIONSID>156309</MAXFK_TRANSACTIONSID>
      </Row>
   </ResultSet>
</Results>]]></con:originalMessage>
        </con:configuration>
      </con:assertion>
      <con:properties/>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="setTransactionID" id="db2af29f-df1b-4c7a-a5a7-251d610f6149">
    <con:settings/>
    <con:config>
      <script>import com.eviware.soapui.impl.wsdl.WsdlProject
testRunner.testCase.getTestStepByName("PreCondition").setPropertyValue("TransactionID",context.expand( '${fetchTransactionID#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/MAXFK_TRANSACTIONSID[1]}' ))</script>
    </con:config>
  </con:testStep>
  <con:testStep type="jdbc" name="fetchJobID" id="68a2b20a-2133-47b7-b564-047ca3b3b3f6">
    <con:settings>
      <con:setting id="prettyPrintResponse">true</con:setting>
    </con:settings>
    <con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:dbConnectionName>PENDATA</con:dbConnectionName>
      <con:driver>oracle.jdbc.driver.OracleDriver</con:driver>
      <con:connectionString>jdbc:oracle:thin:pwhdata/pwh@(DESCRIPTION=(ADDRESS_LIST=(LOAD_BALANCE=ON)(FAILOVER=ON)(ADDRESS=(PROTOCOL=TCP)(HOST=dlt-exa853-scan.unix.cosng.net)(PORT=1530)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=pwh_g_d4)))</con:connectionString>
      <con:password/>
      <con:connectionProperties/>
      <con:query>SELECT 
*
FROM 
ADVICETRANSACTION 
WHERE 
FK_TRANSACTIONSID IN (${PreCondition#TransactionID})</con:query>
      <con:assertion type="Simple Contains" id="5dfb33ff-7131-4127-8458-0e5f0799a2d5" name="Contains">
        <con:configuration>
          <token>rowNumber="1"</token>
          <ignoreCase>false</ignoreCase>
          <useRegEx>false</useRegEx>
        </con:configuration>
      </con:assertion>
      <con:properties/>
    </con:config>
  </con:testStep>
  <con:testStep type="request" id="16846f52-4a12-47c9-9771-0319b9bd5f74" name="PIN_HstRead">
    <con:settings/>
    <con:config xsi:type="con:RequestStep" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:interface>PINSPayment_V2_0PortTypeSoap11</con:interface>
      <con:operation>PaymentHistoricRead</con:operation>
      <con:request name="PIN_HstRead" outgoingWss="" incomingWss="" timeout="" sslKeystore="" useWsAddressing="false" useWsReliableMessaging="false" wssPasswordType="" id="107a076f-6bed-433f-b693-cd87cdf63eb3">
        <con:settings>
          <con:setting id="com.eviware.soapui.impl.wsdl.WsdlRequest@request-headers">&lt;xml-fragment/></con:setting>
        </con:settings>
        <con:encoding>UTF-8</con:encoding>
        <con:endpoint>http://10.246.89.107:23621/pin/services/PINSPayment_V2_0</con:endpoint>
        <con:request><![CDATA[<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:wsc="http://edb.com/ws/WSCommon_v22" xmlns:urn="urn:pins.payment.evry.com:ws:paymentinitiation:v2_0">
   <soapenv:Header>
      <wsc:AutHeader>
         <wsc:SourceApplication>${#TestCase#SourceApplication}</wsc:SourceApplication>
         <wsc:DestinationApplication>${#TestCase#DestinationApplication}</wsc:DestinationApplication>
         <wsc:Function>paymentCreate</wsc:Function>
         <wsc:Version>1.0</wsc:Version>
         <wsc:ClientContext>
            <wsc:userid>E211732</wsc:userid>
            <wsc:credentials>${PreCondition#credentials}</wsc:credentials>
            <wsc:channel>${PreCondition#channel}</wsc:channel>
            <wsc:orgid>${PreCondition#orgid}</wsc:orgid>
            <wsc:customerid>${PreCondition#customerID}</wsc:customerid>
            <wsc:ip>${#TestCase#ip}</wsc:ip>
            <wsc:item key="Employee" value="E211732"/>
            <wsc:item key="SelfService" value="false"/>
            <wsc:item key="LogRef" value="a5c64f54-a6a9-4796-8a2c-35aeb2b3871c"/>
            <wsc:item key="PaymentChannel" value="ITR"/>
         </wsc:ClientContext>
      </wsc:AutHeader>
   </soapenv:Header>
   <soapenv:Body>
      <urn:PaymentHistoricReadRequest>
         <!--You have a CHOICE of the next 2 items at this level-->
         <urn:transactionId>${PreCondition#TransactionID}</urn:transactionId>
      </urn:PaymentHistoricReadRequest>
   </soapenv:Body>
</soapenv:Envelope>]]></con:request>
        <con:assertion type="Simple Contains" id="f6c2a9dd-bc06-408f-88f6-7053c15647c9" name="Contains">
          <con:configuration>
            <token>&lt;Message>OK&lt;/Message></token>
            <ignoreCase>false</ignoreCase>
            <useRegEx>false</useRegEx>
          </con:configuration>
        </con:assertion>
        <con:credentials>
          <con:selectedAuthProfile>No Authorization</con:selectedAuthProfile>
          <con:authType>No Authorization</con:authType>
        </con:credentials>
        <con:jmsConfig JMSDeliveryMode="PERSISTENT"/>
        <con:wsaConfig mustUnderstand="NONE" version="200508" action="urn:pins.payment.evry.com:ws:paymentinitiation:v2_0/PINSPayment_V2_0PortType/PaymentHistoricReadRequest"/>
        <con:wsrmConfig version="1.2"/>
        <con:environmentSpec>
          <con:entry environmentId="50463ace-515e-47d8-a5ec-c52a73e9374f">
            <con:authProfile>No Authorization</con:authProfile>
          </con:entry>
          <con:entry environmentId="4b4c9850-86ff-48ce-bce0-7e16455b6aff">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
          <con:entry environmentId="6acad59c-c71a-413d-ab76-7c4a794d0528">
            <con:authProfile>Inherit From Parent</con:authProfile>
          </con:entry>
        </con:environmentSpec>
      </con:request>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="fetchPain002FromServer" id="7618d7a7-a5da-437a-9517-e1f23c155f71">
    <con:settings/>
    <con:config>
      <script>// Properties
def  ebsHost = context.expand( '${#Project#EBSHost}' )
def  Port =  context.expand( '${#Project#Port}' );
def  ftpUsername = context.expand( '${#Project#UserName}' )
def  ftpPassword = context.expand( '${#Project#Password}' )
def DestinationPath=context.getTestCase().getTestSuite().getProject().getPath()+'\\data'
def  SourcePath = context.expand( '${PreCondition#SourcePath}' )

log.info 'Destination path '+DestinationPath;

def String JobID = context.expand( '${fetchJobID#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/FK_JOBID[1]}' )
def String  MsgID = context.expand( '${PIN_HstRead#Response#declare namespace ns4=\'urn:pins.payment.evry.com:domain:paymentinitiation:v2_0\'; declare namespace ns2=\'urn:pins.payment.evry.com:ws:paymentinitiation:v2_0\'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:result[1]/ns4:messageId[1]}' )
def String JobDate = context.expand( '${fetchJobID#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/ADVICEDATE[1]}' )

JobDate = JobDate.replaceAll("[^a-zA-Z0-9]", "");  
log.info JobDate;

def String FileName = "*."+JobID+"."+MsgID+"."+JobDate.take(12)+"*.xml";
log.info 'File Name is : '+FileName;

//Server connect
if (!(ServerConnect.Connect(ebsHost ,ftpUsername, ftpPassword, Integer.parseInt(Port)) == "PASS"))
	assert false," Failed to conenct to linux server!!"
else
 log.info "Connected to the server successfully!!"

//Find file using partial file name
String findName = "cd $SourcePath &amp;&amp; find . -name '$FileName'"
log.info findName;

//remove line space in file name
def File_Name = ServerConnect.execCommand(findName).replace("\n", "");

//Verify file name
if (File_Name.toString().isEmpty()==true)
{
	testRunner.fail();
	log.info "fetchPain002FromServer step failed, Unable to find the file in server!"
}
else
{
	 log.info 'FileName is  : '+File_Name;

	//Read file from server
	def Pain002_File = ServerConnect.readFileFromServer(SourcePath,File_Name);
	log.info Pain002_File
	
	testRunner.testCase.getTestStepByName("PreCondition").setPropertyValue("Pain002_File",Pain002_File);
}

//Server disconnect
if (!(ServerConnect.closeConnection()))
	assert false," Failed to close linux server!!"
else
 log.info "Connection closed successfully!!"</script>
    </con:config>
  </con:testStep>
  <con:testStep type="delay" name="Delay" id="5f931b50-81c4-4ab9-8e26-48e07b3a82e6">
    <con:settings/>
    <con:config>
      <delay>4000</delay>
    </con:config>
  </con:testStep>
  <con:testStep type="jdbc" name="ADVICETRANSACTION" id="f639eb6e-4893-442e-9144-78df582f5eb2">
    <con:settings>
      <con:setting id="prettyPrintResponse">true</con:setting>
    </con:settings>
    <con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:dbConnectionName>PENDATA</con:dbConnectionName>
      <con:driver>oracle.jdbc.driver.OracleDriver</con:driver>
      <con:connectionString>jdbc:oracle:thin:pwhdata/pwh@(DESCRIPTION=(ADDRESS_LIST=(LOAD_BALANCE=ON)(FAILOVER=ON)(ADDRESS=(PROTOCOL=TCP)(HOST=dlt-exa853-scan.unix.cosng.net)(PORT=1530)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=pwh_g_d4)))</con:connectionString>
      <con:password/>
      <con:connectionProperties/>
      <con:query>SELECT * 
FROM 
ADVICETRANSACTION 
WHERE 
FK_TRANSACTIONSID IN (${PIN_HstRead#Response#declare namespace ns4='urn:pins.payment.evry.com:domain:paymentinitiation:v2_0'; declare namespace ns2='urn:pins.payment.evry.com:ws:paymentinitiation:v2_0'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:result[1]/ns4:transactionId[1]})</con:query>
      <con:assertion type="Simple Contains" id="5dfb33ff-7131-4127-8458-0e5f0799a2d5" name="Contains">
        <con:configuration>
          <token>rowNumber="1"</token>
          <ignoreCase>false</ignoreCase>
          <useRegEx>false</useRegEx>
        </con:configuration>
      </con:assertion>
      <con:properties/>
    </con:config>
  </con:testStep>
  <con:testStep type="jdbc" name="TRANSACTIONS" id="de21f638-b1f7-4c4b-813c-c784466d1386">
    <con:settings>
      <con:setting id="prettyPrintResponse">true</con:setting>
    </con:settings>
    <con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:dbConnectionName>PENDATA</con:dbConnectionName>
      <con:driver>oracle.jdbc.driver.OracleDriver</con:driver>
      <con:connectionString>jdbc:oracle:thin:pwhdata/pwh@(DESCRIPTION=(ADDRESS_LIST=(LOAD_BALANCE=ON)(FAILOVER=ON)(ADDRESS=(PROTOCOL=TCP)(HOST=dlt-exa853-scan.unix.cosng.net)(PORT=1530)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=pwh_g_d4)))</con:connectionString>
      <con:password/>
      <con:connectionProperties/>
      <con:query>SELECT * 
FROM 
TRANSACTIONS
WHERE 
TRANSACTIONSID IN(${PIN_HstRead#Response#declare namespace ns4='urn:pins.payment.evry.com:domain:paymentinitiation:v2_0'; declare namespace ns2='urn:pins.payment.evry.com:ws:paymentinitiation:v2_0'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:result[1]/ns4:transactionId[1]})</con:query>
      <con:assertion type="Simple Contains" id="5dfb33ff-7131-4127-8458-0e5f0799a2d5" name="Contains">
        <con:configuration>
          <token>rowNumber="1"</token>
          <ignoreCase>false</ignoreCase>
          <useRegEx>false</useRegEx>
        </con:configuration>
      </con:assertion>
      <con:properties/>
    </con:config>
  </con:testStep>
  <con:testStep type="jdbc" name="PAYMENTINFO" id="d94dfac8-292d-4718-a0ec-659116105c10">
    <con:settings>
      <con:setting id="prettyPrintResponse">true</con:setting>
    </con:settings>
    <con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:dbConnectionName>PENDATA</con:dbConnectionName>
      <con:driver>oracle.jdbc.driver.OracleDriver</con:driver>
      <con:connectionString>jdbc:oracle:thin:pwhdata/pwh@(DESCRIPTION=(ADDRESS_LIST=(LOAD_BALANCE=ON)(FAILOVER=ON)(ADDRESS=(PROTOCOL=TCP)(HOST=dlt-exa853-scan.unix.cosng.net)(PORT=1530)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=pwh_g_d4)))</con:connectionString>
      <con:password/>
      <con:connectionProperties/>
      <con:query>SELECT * 
FROM 
PAYMENTINFO 
WHERE 
PAYMENTINFOID IN (${TRANSACTIONS#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/FK_PAYMENTINFOID[1]})</con:query>
      <con:assertion type="Simple Contains" id="5dfb33ff-7131-4127-8458-0e5f0799a2d5" name="Contains">
        <con:configuration>
          <token>rowNumber="1"</token>
          <ignoreCase>false</ignoreCase>
          <useRegEx>false</useRegEx>
        </con:configuration>
      </con:assertion>
      <con:properties/>
    </con:config>
  </con:testStep>
  <con:testStep type="jdbc" name="MESSAGE" id="7e9302e4-1600-4492-b333-353aafa1f25b">
    <con:settings>
      <con:setting id="prettyPrintResponse">true</con:setting>
    </con:settings>
    <con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:dbConnectionName>PENDATA</con:dbConnectionName>
      <con:driver>oracle.jdbc.driver.OracleDriver</con:driver>
      <con:connectionString>jdbc:oracle:thin:pwhdata/pwh@(DESCRIPTION=(ADDRESS_LIST=(LOAD_BALANCE=ON)(FAILOVER=ON)(ADDRESS=(PROTOCOL=TCP)(HOST=dlt-exa853-scan.unix.cosng.net)(PORT=1530)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=pwh_g_d4)))</con:connectionString>
      <con:password/>
      <con:connectionProperties/>
      <con:query>SELECT * 
FROM 
MESSAGE 
WHERE 
MESSAGEID IN (${PIN_HstRead#Response#declare namespace ns4='urn:pins.payment.evry.com:domain:paymentinitiation:v2_0'; declare namespace ns2='urn:pins.payment.evry.com:ws:paymentinitiation:v2_0'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:result[1]/ns4:messageId[1]})</con:query>
      <con:assertion type="Simple Contains" id="5dfb33ff-7131-4127-8458-0e5f0799a2d5" name="Contains">
        <con:configuration>
          <token>rowNumber="1"</token>
          <ignoreCase>false</ignoreCase>
          <useRegEx>false</useRegEx>
        </con:configuration>
      </con:assertion>
      <con:properties/>
    </con:config>
  </con:testStep>
  <con:testStep type="jdbc" name="AGENT_PAYMENTINFO" id="ccb63824-f4bd-4e21-99b7-9a2c054bae03">
    <con:settings>
      <con:setting id="prettyPrintResponse">true</con:setting>
    </con:settings>
    <con:config xsi:type="con:JdbcRequestTestStep" convertColumnNamesToUpperCase="true" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">
      <con:dbConnectionName>PENDATA</con:dbConnectionName>
      <con:driver>oracle.jdbc.driver.OracleDriver</con:driver>
      <con:connectionString>jdbc:oracle:thin:pwhdata/pwh@(DESCRIPTION=(ADDRESS_LIST=(LOAD_BALANCE=ON)(FAILOVER=ON)(ADDRESS=(PROTOCOL=TCP)(HOST=dlt-exa853-scan.unix.cosng.net)(PORT=1530)))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME=pwh_g_d4)))</con:connectionString>
      <con:password/>
      <con:connectionProperties/>
      <con:query>SELECT * 
FROM 
AGENT_PAYMENTINFO 
WHERE 
FK_PAYMENTINFOID IN (${TRANSACTIONS#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/FK_PAYMENTINFOID[1]})</con:query>
      <con:assertion type="Simple Contains" id="5dfb33ff-7131-4127-8458-0e5f0799a2d5" name="Contains">
        <con:configuration>
          <token>rowNumber="1"</token>
          <ignoreCase>false</ignoreCase>
          <useRegEx>false</useRegEx>
        </con:configuration>
      </con:assertion>
      <con:properties/>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="Schema Validation" id="27251492-6f8f-49b8-9d02-2e70dd5b98fe">
    <con:settings/>
    <con:config>
      <script>import javax.xml.XMLConstants
import javax.xml.transform.stream.StreamSource
import javax.xml.validation.SchemaFactory
// Specify an XSD Schema
def xsdFilePath = context.expand( '${PreCondition#Pain002SchemaPath}' )
log.info xsdFilePath;
// Get the response as XML
def XML_File = context.expand( '${PreCondition#Pain002_File}' )
// Create validation objects
def factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
def schema = factory.newSchema(new StreamSource(xsdFilePath));
def validator = schema.newValidator();
// Validate the response against the schema
assert validator.validate(new StreamSource(new StringReader(XML_File))) == null;
log.info 'schema validation end'</script>
    </con:config>
  </con:testStep>
  <con:testStep type="groovy" name="PAIN002_Validation" id="65213dfb-c4f1-49d2-9911-ffbab2c3292d">
    <con:settings/>
    <con:config>
      <script>def Pain002_File = context.expand( '${PreCondition#Pain002_File}' )
log.info "Pain002_File :"+Pain002_File;

def XML = new XmlParser().parseText(Pain002_File)

//GrpHdr.MsgId
def MsgId_Actual = XML.CstmrPmtStsRpt.GrpHdr.MsgId.text();
def MessageID = context.expand( '${PIN_HstRead#Response#declare namespace ns4=\'urn:pins.payment.evry.com:domain:paymentinitiation:v2_0\'; declare namespace ns2=\'urn:pins.payment.evry.com:ws:paymentinitiation:v2_0\'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:result[1]/ns4:messageId[1]}' )
def JobID = context.expand( '${ADVICETRANSACTION#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/FK_JOBID[1]}' )
def CustomerID = context.expand( '${MESSAGE#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/AGREEMENTID[1]}' )

def MessageID_Exp = CustomerID+'.'+JobID+'.'+MessageID;
assert MsgId_Actual==MessageID_Exp

//OrgId.BIC
def BIC_Actual = XML.CstmrPmtStsRpt.GrpHdr.InitgPty.Id.OrgId.AnyBIC.text();
def BIC_Exp = context.expand( '${MESSAGE#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/INITIATINGPARTYBICFI[1]}' )

assert BIC_Exp==BIC_Actual;

//ClrSysId
def ClrSysId_Actual = XML.CstmrPmtStsRpt.GrpHdr.DbtrAgt.FinInstnId.ClrSysMmbId.ClrSysId.Prtry.text();

assert 'NOBSK'==ClrSysId_Actual;

//MmbId
def MmbId_Actual = XML.CstmrPmtStsRpt.GrpHdr.DbtrAgt.FinInstnId.ClrSysMmbId.MmbId.text();
def MmbId_Exp = context.expand( '${MESSAGE#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/INITIATORBANKID[1]}' )

assert MmbId_Exp==MmbId_Actual;

if (MmbId_Actual=="4201")
{
	//InitgPty.Nm
	def InitgPty_Actual = XML.CstmrPmtStsRpt.GrpHdr.InitgPty.Nm.text();

	assert 'SpareBank 1 SMN'==InitgPty_Actual
}

//OrgnlMsgId
def OrgnlMsgId_Actual = XML.CstmrPmtStsRpt.OrgnlGrpInfAndSts.OrgnlMsgId.text();
def OrgnlMsgId_Exp = context.expand( '${PIN_HstRead#Response#declare namespace ns4=\'urn:pins.payment.evry.com:domain:paymentinitiation:v2_0\'; declare namespace ns5=\'urn:pins.payment.evry.com:domain:complex-types:v2_0\'; declare namespace ns2=\'urn:pins.payment.evry.com:ws:paymentinitiation:v2_0\'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:result[1]/ns4:paymentIdentification[1]/ns5:messageIdentification[1]}' )

assert OrgnlMsgId_Exp==OrgnlMsgId_Actual;

//OrgnlMsgNmId
def OrgnlMsgNmId_Actual = XML.CstmrPmtStsRpt.OrgnlGrpInfAndSts.OrgnlMsgNmId.text();

assert 'pain.001.001.04'==OrgnlMsgNmId_Actual;

/*


*/

def pmtCount = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts.size();
log.info "Total records in file : "+pmtCount;

for (def i=0;i&lt;pmtCount;i++)
{
	def transID = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].TxInfAndSts.StsRsnInf.AddtlInf[0].text();
	log.info "Record "+i+" = "+transID

	if (transID==context.expand( '${PreCondition#TransactionID}' ))
		{
			log.info "Identified matching record at array "+i;
			
			//OrgnlPmtInfId
			def OrgnlPmtInfId_Actual = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].OrgnlPmtInfId.text();
			def OrgnlPmtInfId_Exp = context.expand( '${PAYMENTINFO#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/PMTINFOID[1]}' )
			
			assert OrgnlPmtInfId_Exp==OrgnlPmtInfId_Actual;
			
			//OrgnlInstrId
			def OrgnlInstrId_Actual = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].TxInfAndSts.OrgnlInstrId.text();
			def OrgnlInstrId_Exp = context.expand( '${TRANSACTIONS#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/INSTRUCTIONID[1]}' )
			
			assert OrgnlInstrId_Exp==OrgnlInstrId_Actual;
			
			//OrgnlEndToEndId
			def OrgnlEndToEndId_Actual = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].TxInfAndSts.OrgnlEndToEndId.text();
			def OrgnlEndToEndId_Exp = context.expand( '${TRANSACTIONS#ResponseAsXml#//Results[1]/ResultSet[1]/Row[1]/ENDTOENDID[1]}' )
			
			assert OrgnlEndToEndId_Exp==OrgnlEndToEndId_Actual;
			
			//TxSts
			def TxSts_Actual = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].TxInfAndSts.TxSts.text();
			
			assert 'RJCT'==TxSts_Actual;
			
			//StsRsnInf
			def StsRsnInf_Actual = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].TxInfAndSts.StsRsnInf.Rsn.Cd.text();
			def StsRsnInf_Exp = context.expand( '${PIN_HstRead#Response#declare namespace ns4=\'urn:pins.payment.evry.com:domain:paymentinitiation:v2_0\'; declare namespace ns5=\'urn:pins.payment.evry.com:domain:complex-types:v2_0\'; declare namespace ns2=\'urn:pins.payment.evry.com:ws:paymentinitiation:v2_0\'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:statusReason[1]/ns5:code[1]}' )
			
			assert StsRsnInf_Exp==StsRsnInf_Actual;
			
			//AddtlInf-1
			def AddtlInf1_Actual = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].TxInfAndSts.StsRsnInf.AddtlInf[0].text();
			def AddtlInf1_Exp = context.expand( '${PIN_HstRead#Response#declare namespace ns4=\'urn:pins.payment.evry.com:domain:paymentinitiation:v2_0\'; declare namespace ns2=\'urn:pins.payment.evry.com:ws:paymentinitiation:v2_0\'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:result[1]/ns4:transactionId[1]}' )
			
			assert AddtlInf1_Exp==AddtlInf1_Actual;
			
			//AddtlInf-2
			def AddtlInf2_Exp = context.expand( '${PIN_HstRead#Response#declare namespace ns4=\'urn:pins.payment.evry.com:domain:paymentinitiation:v2_0\'; declare namespace ns5=\'urn:pins.payment.evry.com:domain:complex-types:v2_0\'; declare namespace ns2=\'urn:pins.payment.evry.com:ws:paymentinitiation:v2_0\'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:statusReason[1]/ns5:additionalInfo[1]}' )
			
			if(AddtlInf2_Exp!="")
			{
				def AddtlInf2_Actual = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].TxInfAndSts.StsRsnInf.AddtlInf[1].text();
				assert AddtlInf2_Exp==AddtlInf2_Actual;
				
				log.info "Verified Addtllnf2";
			}
			
			//AddtlInf-3
			def AddtlInf3_Exp = context.expand( '${PIN_HstRead#Response#declare namespace ns4=\'urn:pins.payment.evry.com:domain:paymentinitiation:v2_0\'; declare namespace ns5=\'urn:pins.payment.evry.com:domain:complex-types:v2_0\'; declare namespace ns2=\'urn:pins.payment.evry.com:ws:paymentinitiation:v2_0\'; //ns2:PaymentHistoricReadResponse[1]/ns2:paymentResult[1]/ns4:statusReason[1]/ns5:additionalInfo[2]}' )
			
			if(AddtlInf3_Exp!="")
			{
				def AddtlInf3_Actual = XML.CstmrPmtStsRpt.OrgnlPmtInfAndSts[i].TxInfAndSts.StsRsnInf.AddtlInf[2].text();
				assert AddtlInf3_Exp==AddtlInf3_Actual;
				
				log.info "Verified Addtllnf3";
			}
			break;
		}
}</script>
    </con:config>
  </con:testStep>
  <con:properties>
    <con:property>
      <con:name>SourceApplication</con:name>
      <con:value>EVRYCPS</con:value>
    </con:property>
    <con:property>
      <con:name>DestinationApplication</con:name>
      <con:value>PINS</con:value>
    </con:property>
    <con:property>
      <con:name>ip</con:name>
      <con:value>10.235.84.79</con:value>
    </con:property>
    <con:property>
      <con:name>orgunit</con:name>
      <con:value>CORP</con:value>
    </con:property>
    <con:property>
      <con:name>requestedExecutionDate</con:name>
      <con:value>2020-05-11+05:00</con:value>
    </con:property>
    <con:property>
      <con:name>SessionID</con:name>
      <con:value>20200511694</con:value>
    </con:property>
  </con:properties>
  <con:reportParameters/>
  <con:breakPoints>
    <con:testStepId>e7d0cf6c-ff26-40de-9ae2-3a3fe5c69e36</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>88beb3b8-3a11-4c79-99a8-4d5d7182fc48</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>575c1fff-2018-4c87-bde6-12b95e3b1255</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>85f7636a-fd28-44aa-89c5-5ece3216290d</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>3fd09ccc-13ea-47c8-8b94-4cc80eb8a71c</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>f3f186ac-87e4-48ac-ac3c-2c478768a58e</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>d204c74c-1b29-4b35-b971-f64934034482</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>658df31d-91d4-4ce4-8ce9-29e33be94e01</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>b1f36393-d563-4bb3-8830-82a44ca085ce</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>b2d34739-fb24-484b-b92c-1c3e5e4da21b</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>5f931b50-81c4-4ab9-8e26-48e07b3a82e6</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>44fcbede-ad8b-4bd0-bc14-99c9643e4a1e</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>db2af29f-df1b-4c7a-a5a7-251d610f6149</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
  <con:breakPoints>
    <con:testStepId>854c2d27-58e2-4824-9cf5-16bb46f23b02</con:testStepId>
    <con:status>NONE</con:status>
    <con:properties/>
  </con:breakPoints>
</con:testCase>
